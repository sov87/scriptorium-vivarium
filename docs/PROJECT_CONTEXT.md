# SCRIPTORIUM — Project Context (Living Document)
Last updated: 2026-02-27

## Core goal
Local-first, reproducible pipeline that ingests historical text corpora into a structured
SQLite database with:
- Canonical archival JSONL intermediate
- FTS + vector retrieval
- Optional LLM answer/gloss generation with audit-traceable artifacts
- Defensible provenance/rights discipline

Long-term scope (planned):
- Old English / Anglo-Saxon (current)
- Latin (Perseus / Open Greek & Latin where openly licensed)
- Ancient Greek (canonical-greekLit / Open Greek & Latin where openly licensed)
- Patristic / liturgical public-domain corpora (e.g., CCEL subsets and other openly
  available DH repos)

Vivarium long-term goal: open-ended, dynamic "fly-on-the-wall" historical city simulation
(Rome first) powered entirely by primary sources. Users can walk through ancient Rome in
present-tense prose. Every concrete factual claim traces to a real source segment.
Similar to a MUD but non-gamey, non-scripted, grounded in evidence.

## Non-negotiables
- Local-first/offline-capable: core build/search runs without cloud dependencies
  (LLM calls optional).
- Canonical intermediate: archival JSONL is the "source of truth" for processed text
  (no silent mutation).
- Provenance and rights: every corpus must have explicit rights/provenance notes in
  the catalog/ledger.
- Audit chain for AI: answer-search produces cites; answer-show resolves cited passages
  from the DB.
- CI must not call an LLM (seeded artifacts only).

## Environment (known working)
- Windows 11
- Scriptorium project root: F:\Books\as_project
- Primary venv: F:\Books\as_project\.venv_clean\
  Activate: .\.venv_clean\Scripts\Activate.ps1
- Vivarium repo root: F:\Books\scriptorium-vivarium
  Activate: .\.venv\Scripts\Activate.ps1
- Local LLM: LM Studio at http://localhost:1234/v1
  Model: qwen3-30b-a3b-instruct-2507
  IMPORTANT: Qwen3 runs in "thinking" mode by default which burns tokens silently.
  Mitigated by prepending /no_think to each user message in the script (already done).
  Do NOT use fine-tuning to fix schema compliance — it undermines the citation architecture.

## Key configs and DBs
- Rome core config: configs\vivarium_rome_core.toml
- Rome core DB: db\vivarium_rome_core.sqlite (~200MB+; use this for Vivarium)
- Rome core registry: docs\registry_rome_core.generated.json
  (generated by tools\make_rome_core_registry.py)
- Broad DB: db\vivarium_rome.sqlite (too broad; causes retrieval drift; avoid)
- CI config: configs\sample_demo_ci_strict.toml
- CI DB: db\scriptorium_ci.sqlite (via root.db_path)
- Local work config: configs\window_0597_0865.toml
- Local DB: db\scriptorium.sqlite

## How to run Vivarium (correct invocation)
```
cd F:\Books\scriptorium-vivarium
.\.venv\Scripts\Activate.ps1
python .\tools\rome_experience_cli.py `
  --db "F:\Books\as_project\db\vivarium_rome_core.sqlite" `
  --base-url "http://localhost:1234/v1" `
  --model "qwen3-30b-a3b-instruct-2507" `
  --max-tokens 8192 `
  --debug
```

## How to rebuild the Rome core DB (correct; no swap)
```
cd F:\Books\as_project
python -m scriptorium db-build `
  --config configs\vivarium_rome_core.toml `
  --registry-override docs\registry_rome_core.generated.json `
  --overwrite
```

## Current capabilities (milestones reached)
- DB build + FTS search + vector index build + hybrid retrieval.
- AI answer pipeline with audit chain (answer-db → import → search → show).
- CI smoke test with provenance gate (sha256 verified, strict mode enforced).
- Registry override (P0 fix, Feb 2026):
  - db-build now accepts --registry-override <path>.
  - docs/corpora.json is NEVER swapped/mutated during subset builds.
  - tools/build_db_from_registry.py and tools/build_demo_db_from_private.py
    both updated to use --registry-override.
  - Verified working 2026-02-27.
- Platner & Ashby ingest (Feb 2026):
  - 1841 entries scraped from Perseus Digital Library (1999.04.0054).
  - Script: tools/platner_ashby_scraper.py (polite scraper, 1.5s delay, --resume support).
  - Registered as corpus_id: platner_ashby_1929 in corpora.private.json.
  - Included in registry_rome_core.generated.json and vivarium_rome_core.sqlite.
  - Confirmed working: evidence IDs like platner_ashby_1929:forum-romanum appear
    in Vivarium evidence packets.
- Vivarium CLI (F:\Books\scriptorium-vivarium\tools\rome_experience_cli.py):
  - Stateful game engine with ROME_GRAPH navigation, fatigue, day/time tracking.
  - Quota-based retrieval: topography / daily life / politics buckets.
  - /no_think prepended to each user message (fixes Qwen3 thinking token bleed).
  - Validation minimums relaxed (npc_activity 3-12, observations 3-12, claims 3-16).
  - CLICHE_OPENINGS expanded to catch "The morning sun..." pattern.
  - AUTO_GOTO_RE guarded with best_overlap >= 1 check (NPC names no longer
    trigger failed location moves).
  - best_overlap initialized before if/else to fix UnboundLocalError on exact matches.
  - Query builder fixed: location tokens no longer ANDed into topography query
    (was preventing Latin literature from ranking into evidence packets).
  - Bug fixes from previous session: backfill dead no-op, extra-key validation,
    missing return after die().

## Current Rome core DB sources
- Full PerseusDL canonical-latinLit corpus (TEI + CTS; CC BY-SA 4.0)
  Covers: Livy, Cicero, Tacitus, Pliny, Martial, Juvenal, Vitruvius, Varro,
  Suetonius, and much more.
- Smith's Dictionaries (Antiquities, Geography, Biography — Perseus TEI; CC BY-SA 4.0)
- Platner & Ashby, Topographical Dictionary of Ancient Rome (1929; public domain)
  1841 entries. Every named place, building, monument, road in ancient Rome.
- Pleiades places gazetteer (viv_pleiades_places corpus)
  Used for :place lookups and location grounding. EXCLUDED from narrative retrieval
  (Pleiades is too broad and dominates FTS ranking if included).
- Additional private corpora (see docs/corpora.private.json; not committed)

## Known retrieval behavior
- FTS5 with unicode61 remove_diacritics 2 tokenizer.
- Latin literature IS in the DB and IS being retrieved (confirmed 2026-02-27).
- Pleiades dominates naive FTS queries because it contains millions of place name
  entries including modern ones. It is filtered out of narrative packets in
  retrieve_packet_with_quotas() via PLEIADES_CORPUS_ID check.
- Query builder now uses intent tokens only (not location tokens) for topography
  query, which allows Latin literature to rank alongside Platner & Ashby.
- Evidence packets now contain mix of platner_ashby_1929 and viv_latinlit_* entries.

## Known gaps / next priorities
1. NPC dialogue: "Talk to X" generates more atmosphere instead of actual speech.
   Fix: add hard rule to system prompt — when user attempts to speak to an NPC,
   generate actual spoken dialogue, not more environmental description.
2. Scene continuity: model sometimes resets atmosphere between turns instead of
   advancing the scene. History deque (maxlen=3) helps but prompt needs stronger
   instruction to progress action not repeat it.
3. Qwen 3.5 32B: reportedly much better than 3.0 30B. Easy swap — just change
   --model flag. Test when available in LM Studio.
4. Persistent world state between CLI restarts: currently resets on every launch.
   Simple sqlite session table would fix this.
5. Spatial navigation via Pleiades coords: "walk north" could use coord lookup.
6. Vector retrieval: FTS ceiling is real for inflected Latin/Greek. Optional vec
   index already exists in pipeline; promote to active use when FTS becomes bottleneck.
7. More daily life texture sources: Petronius, Apuleius not yet ingested.
   These would help "talk to NPC" scenarios with social texture evidence.

## What NOT to do (learned the hard way)
- Do NOT copy build_db_from_registry.py into src/build_sqlite_db.py — different
  files with different argument signatures.
- Do NOT swap docs/corpora.json for subset builds — use --registry-override.
- Do NOT AND location tokens into the topography FTS query — kills Latin literature
  retrieval because primary sources don't say "rome" in every passage.
- Do NOT include Pleiades in narrative retrieval — it dominates ranking with
  millions of entries including modern place names.
- Do NOT rely on --max-tokens alone to fix JSON truncation with Qwen3 — the model
  burns tokens on internal thinking before output. Use /no_think instead.
- Do NOT fine-tune the model to fix schema compliance — it undermines the citation
  architecture and makes confabulation harder to detect.
- Do NOT let AI sessions touch multiple files at once without reading them first.
  Instruct: "Do not assume anything about file contents you haven't seen — ask for
  the file before changing it."

## Catalog
- Source catalog: docs/sources_catalog.json
- Rule: do not add new corpora without updating catalog + rights/provenance notes.
- Public/distributable registry: docs/corpora.public.json (committed)
- Private/local registry: docs/corpora.private.json (NOT committed; local only)

## Preferred open sources (Latin/Greek TEI)
- PerseusDL canonical-latinLit (TEI + CTS; CC BY-SA 4.0)
- PerseusDL canonical-greekLit (TEI + CTS; CC BY-SA 4.0)
- OpenGreekAndLatin First1KGreek (TEI; CC BY-SA 4.0)

## Session protocol (prevents token spiral)
- End of session: update this file's milestones and next priorities, commit.
- New chat start: paste contents of PROJECT_CONTEXT.md and DECISIONS.md and say:
  "Continue from next priorities. Do not assume anything about file contents you
  haven't seen — ask for files before changing them."
- Commit this file alongside the code changes it reflects.

## Current status quick check
```
python -m scriptorium check-ai-fts --config configs\window_0597_0865.toml --json
```
